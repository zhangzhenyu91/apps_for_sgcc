name: Deploy

on:
  push:
    branches:
      - main  # 触发部署的分支

jobs:
  deploy:
    runs-on: ubuntu-latest
    # 设置作业的权限，确保 GITHUB_TOKEN 有足够权限推送代码到 gh-pages
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4  # 升级到最新稳定版
        with:
          fetch-depth: 0  # 拉取完整提交历史，避免构建时缺少信息

      - name: Setup Node.js
        uses: actions/setup-node@v4  # 升级到最新稳定版
        with:
          node-version: 20  # 使用 Node.js 20 LTS（16 已过时）
          cache: 'npm'  # 缓存 npm 依赖，加速安装

      - name: Install dependencies
        run: npm install --frozen-lockfile
        # 添加错误捕获，依赖安装失败时明确提示
        continue-on-error: false

      - name: Build VitePress docs
        run: npm run docs:build
        # 构建失败时终止流程并提示
        continue-on-error: false

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4  # 升级到最新稳定版
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}  # 修复拼写错误
          publish_dir: ./docs/.vitepress/dist  # 明确路径前缀，避免歧义
          publish_branch: gh-pages  # 部署到 gh-pages 分支
          full_commit_message: ${{ github.event.head_commit.message }}
          # 可选：清理 gh-pages 分支上的旧文件，避免冗余
          clean: true
          # 可选：如果需要强制推送（解决历史冲突）
          force_orphan: true